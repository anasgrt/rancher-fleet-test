apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: prometheus
  namespace: kube-system
spec:
  # Prometheus Community Helm chart
  repo: https://prometheus-community.github.io/helm-charts
  chart: kube-prometheus-stack
  version: 65.8.1
  targetNamespace: prometheus-monitoring
  createNamespace: true
  valuesContent: |-
    # Prometheus configuration
    prometheus:
      prometheusSpec:
        retention: 30d
        resources:
          requests:
            memory: "2Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 50Gi

        # Additional scrape configs for federation
        # Federates metrics from all downstream cluster Prometheus instances
        additionalScrapeConfigs:
          - job_name: 'federate-downstream-clusters'
            scrape_interval: 30s
            scrape_timeout: 25s
            honor_labels: true
            metrics_path: '/federate'
            params:
              'match[]':
                # Federate all time series
                - '{__name__=~".+"}'

            # Static configs for downstream clusters
            # To add a new cluster:
            # 1. Deploy Prometheus to the cluster (via key/gitrepos/common/prometheus)
            # 2. Add entry below with format: '<control-plane-ip>:30090'
            # 3. Commit and push - Fleet will auto-deploy the update
            static_configs:
              # Key cluster Prometheus (exposed on NodePort 30090)
              - targets: ['192.168.56.20:30090']
                labels:
                  cluster: 'key'
                  cluster_type: 'downstream'
                  prometheus_instance: 'key-prometheus'
                  environment: 'key'

              # Template for adding new clusters:
              # - targets: ['<control-plane-ip>:30090']
              #   labels:
              #     cluster: '<cluster-name>'
              #     cluster_type: 'downstream'
              #     prometheus_instance: '<cluster-name>-prometheus'
              #     environment: '<env-label>'

    # Grafana configuration
    grafana:
      enabled: true
      adminPassword: "admin"
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
      persistence:
        enabled: true
        size: 10Gi

    # AlertManager configuration
    alertmanager:
      enabled: true
      alertmanagerSpec:
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        storage:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 10Gi

    # Node Exporter - exports node metrics
    nodeExporter:
      enabled: true

    # Kube State Metrics - exports k8s object metrics
    kubeStateMetrics:
      enabled: true

    # Service monitors for automatic scraping
    kubeApiServer:
      enabled: true
    kubelet:
      enabled: true
    kubeControllerManager:
      enabled: true
    coreDns:
      enabled: true
    kubeEtcd:
      enabled: true
    kubeScheduler:
      enabled: true
    kubeProxy:
      enabled: true
