apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: prometheus
  namespace: kube-system
spec:
  # Prometheus Community Helm chart
  repo: https://prometheus-community.github.io/helm-charts
  chart: kube-prometheus-stack
  version: 65.8.1
  targetNamespace: prometheus-monitoring
  createNamespace: true
  valuesContent: |-
    # Prometheus configuration
    prometheus:
      prometheusSpec:
        retention: 7d
        externalLabels:
          cluster: 'key'
          cluster_type: 'downstream'
          environment: 'key'
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        # Disable persistence - no storage provisioner on downstream cluster
        storageSpec: {}

        # Attach node metadata to pod metrics for better federation support
        podMonitorSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false

      # Expose Prometheus as NodePort for federation from management cluster
      service:
        type: NodePort
        nodePort: 30090

    # Grafana configuration
    grafana:
      enabled: true
      adminPassword: "admin"
      resources:
        requests:
          memory: "128Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "250m"
      # Disable persistence - no storage provisioner on downstream cluster
      persistence:
        enabled: false

    # AlertManager configuration
    alertmanager:
      enabled: true
      alertmanagerSpec:
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "100m"
        # Disable persistence - no storage provisioner on downstream cluster
        storage: {}

    # Node Exporter - exports node metrics
    nodeExporter:
      enabled: true

    # Prometheus Node Exporter subchart configuration
    # This ensures node labels are attached to all node-exporter metrics
    prometheus-node-exporter:
      prometheus:
        monitor:
          attachMetadata:
            node: true

    # Kube State Metrics - exports k8s object metrics
    kubeStateMetrics:
      enabled: true

    # Prometheus Operator configuration
    # Attach node metadata to all scraped metrics
    prometheusOperator:
      prometheusConfigReloader:
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi

    # Service monitors for automatic scraping
    # Enable node label attachment for better Grafana dashboard compatibility
    kubeApiServer:
      enabled: true
    kubelet:
      enabled: true
      serviceMonitor:
        attachMetadata:
          node: true
    kubeControllerManager:
      enabled: true
    coreDns:
      enabled: true
    kubeEtcd:
      enabled: true
    kubeScheduler:
      enabled: true
    kubeProxy:
      enabled: true
